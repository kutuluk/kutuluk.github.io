var t=function(t,e){this.x=t||0,this.y=e||0};t.prototype.from=function(t){return this.x=t.x,this.y=t.y,this},t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},t.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this},t.prototype.invert=function(){return this.x*=-1,this.y*=-1,this},t.prototype.mul=function(t){return this.x*=t,this.y*=t,this},t.prototype.div=function(t){return 0===t?(this.x=0,this.y=0):(this.x/=t,this.y/=t),this},t.prototype.norm=function(){var t=this.length();return 0===t?(this.x=1,this.y=0):this.div(t),this},t.prototype.rotate=function(t){var e=this.x*Math.cos(t)-this.y*Math.sin(t),r=this.x*Math.sin(t)+this.y*Math.cos(t);return this.x=e,this.y=r,this},t.prototype.lengthSq=function(){return this.x*this.x+this.y*this.y},t.prototype.length=function(){return Math.sqrt(this.lengthSq())},t.prototype.distanceSq=function(t){var e=this.x-t.x,r=this.y-t.y;return e*e+r*r},t.prototype.distance=function(t){return Math.sqrt(this.distanceSq(t))},t.prototype.angle=function(){return Math.atan2(this.y,this.x)},t.prototype.cross=function(t){return this.x*t.y-this.y*t.x},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y},t.prototype.clone=function(){return new t(this.x,this.y)};var e=function(t){function e(e,r,n){t.call(this,e,r),this.rotation=n||0}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e}(t),r=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e}(e),n=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),(e.prototype=Object.create(t&&t.prototype)).constructor=e,e}(e),i=function(t,e,r,n){this.texture=t,this.tint=0===e?0:e||16777215,this.alpha=0===r?0:r||1,this.scale=0===n?0:n||1},o=function(t){this.transformer=t,this.remaining=t.duration},a=function(){},s=function(){this.target=null,this.distance=null,this.speed=150*(1+Math.random()/4),this.agi=Math.PI/48*(1+Math.random()/4)},h=function(e){return new t(Math.cos(e),Math.sin(e))},c=function(t){return void 0===t&&(t=1),(Math.random()-.5)*t},u=function(t){this.selector=t.select(r,n)};u.prototype.update=function(t){this.selector.iterate(function(e){var i=e.get(r),o=e.get(n);i.add(o.clone().mul(t)),i.rotation+=o.rotation*t})};var f={duration:.5,end:function(t){t.eject()},update:function(t,e){var r=t.get(i);r&&(r.alpha=e)}},l=function(t,e){this.ecs=t,this.texture=e,this.selector=t.select(s,r)};l.prototype.update=function(){var t=this;this.selector.iterate(function(e){var a=e.get(r),s=h(a.rotation+Math.PI*c()),u=h(a.rotation).mul(8);t.ecs.create().add((new r).from(a).sub(u),(new n).from(s).mul(20*Math.random()),new i(t.texture,16513420),new o(f))})};var d=function(t){this.selector=t.select(o)};d.prototype.update=function(t){this.selector.iterate(function(e){var r=e.get(o);if(r.remaining-=t,r.remaining<=0){if(r.transformer.end&&r.transformer.end(e),r.transformer=r.transformer.next,!r.transformer)return void e.remove(o);r.remaining+=r.transformer.duration}r.transformer.update&&r.transformer.update(e,r.remaining/r.transformer.duration)})};var p=function(t,e){this.ecs=t,this.hunters=t.select(s),this.bounties=t.select(a),this.hunterTransform={duration:1/6,update:function(t,e){var r=t.get(i);r&&(r.scale=1+.2*(1-e))},next:{duration:.25,update:function(t,e){var r=t.get(i);r&&(r.scale=1.2-.2*(1-e))},end:function(t){var e=t.get(i);e&&(e.scale=1)}}},this.deathTransform={duration:.25,end:function(a){var s=a.get(r);if(s)for(var c=0;c<2*Math.PI;c+=Math.PI/10){var u=h(c).mul(100*(1+Math.random()));t.create().add((new r).from(s),(new n).from(u),new i(e,15885337),new o(f))}a.eject()},update:function(t,e){var r=t.get(i);r&&(r.scale=e)}}};p.prototype.update=function(t){var e=this;this.hunters.iterate(function(t){var r=t.get(s);if(r.distance&&r.distance<144){var n=r.target;n.has(a)&&(n.remove(a),n.add(new o(e.deathTransform)),t.add(new o(e.hunterTransform)))}r.target=null,r.distance=null}),this.bounties.iterate(function(t){var n=t.get(r);e.hunters.iterate(function(e){var i=e.get(s),o=e.get(r).distanceSq(n);(null===i.distance||i.distance>o)&&(i.distance=o,i.target=t)})}),this.hunters.iterate(function(e){var i=e.get(r),o=e.get(s),a=o.target,c=o.speed,u=o.agi,f=e.get(n);if(a){var l=a.get(r).clone().sub(i).norm(),d=h(i.rotation),p=Math.atan2(d.cross(l),d.dot(l));if(Math.abs(p)>u)p=u*(p<0?-1:1);f.from(d).mul(c),f.rotation=p/t}else f.x=0,f.y=0,f.rotation=0})};var v=function(t,e,r,n){this.ecs=t,this.amount=r,this.texture=n,this.view=e,this.selector=t.select(a),this.spawnTransform={duration:1,update:function(t,e){var r=t.get(i);r&&(r.scale=1-e)}}};v.prototype.update=function(){for(var t=this.view,e=t.width,s=t.height,h=.05*(e+s),u=this.selector.length;u<this.amount;u++)this.ecs.create().add(new r(h+Math.random()*(e-2*h),h+Math.random()*(s-2*h),2*Math.random()*Math.PI),new n(c(3),c(3),c(2)*Math.PI),new a,new i(this.texture,null,null,0),new o(this.spawnTransform))};var m=function(t,e){this.scene=e,this.selector=t.select(r,i)};m.prototype.update=function(){var t=this;this.scene.resize(),this.scene.cls(),this.selector.iterate(function(e){var n=e.get(r),o=e.get(i),a=o.texture,s=o.tint,h=o.scale;t.scene.col=(255*o.alpha<<24|(16711680&s)>>16|65280&s|(255&s)<<16)>>>0,t.scene.img(a,-a.width/2,-a.height/2,a.width,a.height,n.rotation,n.x,n.y,h,h,0,0,1,1)}),this.scene.flush()};var g=[],y=[],x={},b="_sign",w="_mask";Symbol&&(b=Symbol(b),w=Symbol(w));var E=function(t,e){var r=e[t];if(!r)throw new Error("The component is not registered");return r},T=E.bind(null,b),A=E.bind(null,w),M=function(t){t.id&&g.forEach(function(e){return e.match(t)})},_=1,P=function(t){this.id=t||(_++).toString(36),this.components={},this.mask=0};P.prototype.add=function(){for(var t=arguments,e=this,r=[],n=arguments.length;n--;)r[n]=t[n];r.forEach(function(t){e.components[T(t.constructor)]=t,e.mask|=A(t.constructor)}),M(this)},P.prototype.remove=function(){for(var t=arguments,e=this,r=[],n=arguments.length;n--;)r[n]=t[n];r.forEach(function(t){var r=T(t),n=e.components[r];n&&(n.destructor&&n.destructor(),delete e.components[r],e.mask&=~A(t))}),M(this)},P.prototype.has=function(t){return T(t)in this.components},P.prototype.get=function(t){return this.components[T(t)]},P.prototype.eject=function(){var t;t=this,Object.values(t.components).forEach(function(t){return t.destructor&&t.destructor()}),g.forEach(function(e){return e.remove(t)}),delete x[t.id],t.id=0};var S=function(t){var e=this;if(!t)throw new Error("Empty selector");this.mask=t,this.map={},this.list=null,this.length=0,Object.values(x).forEach(function(t){return e.match(t)})};S.prototype.iterate=function(t){for(var e=this.list;e;)t(e.entity),e=e.next},S.prototype.match=function(t){(this.mask&t.mask)===this.mask?this.add(t):this.remove(t)},S.prototype.add=function(t){if(!this.map[t.id]){var e=new function(t,e){this.entity=t,this.prev=null,this.next=e}(t,this.list);this.list&&(this.list.prev=e),this.list=e,this.map[t.id]=e,this.length++}},S.prototype.remove=function(t){var e=this.map[t.id];e&&(e.prev?e.prev.next=e.next:this.list=e.next,e.next&&(e.next.prev=e.prev),delete this.map[t.id],this.length--)};var R=0,D=performance||Date,I=D.now.bind(D),B={register:function(){for(var t=arguments,e=[],r=arguments.length;r--;)e[r]=t[r];e.forEach(function(t){if(R>31)throw new Error("Components limit reached");t[b]||(t[b]=R.toString(36),t[w]=1<<R,R++)})},process:function(){for(var t=arguments,e=[],r=arguments.length;r--;)e[r]=t[r];e.forEach(function(t){return y.push(t)})},create:function(t){var e=new P(t);if(x[e.id])throw new Error("The ID already exist");return x[e.id]=e,e},get:function(t){return x[t]},select:function(){for(var t=arguments,e=[],r=arguments.length;r--;)e[r]=t[r];var n=0;e.forEach(function(t){n|=A(t)});var i=g.find(function(t){return t.mask===n});if(i)return i;var o=new S(n);return g.push(o),o},update:function(t){var e={};return y.forEach(function(r){var n=I();r.update(t),e[r.constructor.name]=I()-n}),e}};function k(t,e,r){var n=t.createShader(r);return t.shaderSource(n,e),t.compileShader(n),n}function L(t,e,r,n){var i=t.createBuffer();return t.bindBuffer(e,i),t.bufferData(e,r,n),i}function U(t,e,r,n){var i=t.createTexture();return t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.bindTexture(t.TEXTURE_2D,null),i.width=r,i.height=n,i}var j=document.getElementById("view"),X=function(t){var e,r,n,i,o,a,s=t.getContext("webgl"),h=function(t,e,r){var n=k(t,e,t.VERTEX_SHADER),i=k(t,r,t.FRAGMENT_SHADER),o=t.createProgram();return t.attachShader(o,n),t.attachShader(o,i),t.linkProgram(o),o}(s,["precision lowp float;","attribute float a;","attribute vec2 b,c,d,e;","attribute vec4 f;","varying vec2 g;","varying vec4 h;","uniform mat4 i;","void main() {","float q=cos(a);","float w=sin(a);","gl_Position=i*vec4(((vec2(d.x*q-d.y*w,d.x*w+d.y*q)*c)+b),1.0,1.0);","g=e;","h=f;","}"].join("\n"),["precision lowp float;","varying vec2 g;","varying vec4 h;","uniform sampler2D j;","void main(){","gl_FragColor=texture2D(j,g)*h;","}"].join("\n")),c=s.bufferSubData.bind(s),u=s.drawElements.bind(s),f=s.bindTexture.bind(s),l=(s.clear.bind(s),s.clearColor.bind(s),new ArrayBuffer(1747520)),d=new Float32Array(l),p=new Uint32Array(l),v=new Uint16Array(131064),m=L(s,34963,v.byteLength,35044),g=L(s,34962,l.byteLength,35048),y=0,x=null,b=null;s.blendFunc(770,771),s.enable(3042),s.useProgram(h),s.bindBuffer(34963,m);for(var w=indexB=0;w<65532;w+=6,indexB+=4)v[w+0]=indexB,v[w+1]=indexB+1,v[w+2]=indexB+2,v[w+3]=indexB+0,v[w+4]=indexB+3,v[w+5]=indexB+1;return s.bufferSubData(34963,0,v),s.bindBuffer(34962,g),e=s.getAttribLocation(h,"a"),r=s.getAttribLocation(h,"b"),n=s.getAttribLocation(h,"c"),i=s.getAttribLocation(h,"d"),o=s.getAttribLocation(h,"e"),a=s.getAttribLocation(h,"f"),s.enableVertexAttribArray(e),s.vertexAttribPointer(e,1,5126,0,40,0),s.enableVertexAttribArray(r),s.vertexAttribPointer(r,2,5126,0,40,4),s.enableVertexAttribArray(n),s.vertexAttribPointer(n,2,5126,0,40,12),s.enableVertexAttribArray(i),s.vertexAttribPointer(i,2,5126,0,40,20),s.enableVertexAttribArray(o),s.vertexAttribPointer(o,2,5126,0,40,28),s.enableVertexAttribArray(a),s.vertexAttribPointer(a,4,5121,1,40,36),s.activeTexture(33984),(b={g:s,c:t,col:4294967295,bkg:function(t,e,r){s.clearColor(t,e,r,1)},cls:function(){s.clear(16384)},resize:function(){var e=t.clientWidth,r=t.clientHeight;t.width===e&&t.height===r||(t.width=e,t.height=r,s.uniformMatrix4fv(s.getUniformLocation(h,"i"),0,new Float32Array([2/e,0,0,0,0,-2/r,0,0,0,0,1,1,-1,1,0,0])),s.viewport(0,0,e,r))},img:function(t,e,r,n,i,o,a,s,h,v,m,g,w,E){var T=e,A=r,M=e+n,_=r+i,P=e,S=r+i,R=e+n,D=r,I=0,B=b.col;(t!=x||y+1>=10922)&&(c(34962,0,l),u(4,6*y,5123,0),y=0,t!=x&&f(3553,x=t)),I=40*y,d[I++]=o,d[I++]=a,d[I++]=s,d[I++]=h,d[I++]=v,d[I++]=T,d[I++]=A,d[I++]=m,d[I++]=g,p[I++]=B,d[I++]=o,d[I++]=a,d[I++]=s,d[I++]=h,d[I++]=v,d[I++]=M,d[I++]=_,d[I++]=w,d[I++]=E,p[I++]=B,d[I++]=o,d[I++]=a,d[I++]=s,d[I++]=h,d[I++]=v,d[I++]=P,d[I++]=S,d[I++]=m,d[I++]=E,p[I++]=B,d[I++]=o,d[I++]=a,d[I++]=s,d[I++]=h,d[I++]=v,d[I++]=R,d[I++]=D,d[I++]=w,d[I++]=g,p[I++]=B,++y>=10922&&(c(34962,0,l),u(4,6*y,5123,0),y=0)},flush:function(){0!=y&&(c(34962,0,d.subarray(0,40*y)),u(4,6*y,5123,0),y=0)}}).resize(),b}(j);X.bkg(.2,.2,.2);var q=X.g,C=document.createElement("canvas");C.width=32,C.height=32;var F=C.getContext("2d");F.lineWidth=2,F.fillStyle="#33658a",F.strokeStyle="#86bbd8",F.beginPath(),F.moveTo(16,16);for(var G=0;G<2*Math.PI;G+=2*Math.PI/5)F.lineTo(16+15*Math.cos(G),16+15*Math.sin(G));F.closePath(),F.fill(),F.stroke();var O=U(q,C,16,16);F.clearRect(0,0,C.width,C.height),F.fillStyle="#30644f",F.strokeStyle="#7eb77c",F.beginPath(),F.moveTo(1,1),F.lineTo(30,16),F.lineTo(1,30),F.lineTo(8,16),F.closePath(),F.fill(),F.stroke();var V=U(q,C,16,16);F.fillStyle="#ffffff",F.fillRect(0,0,C.width,C.height);var N=U(q,C,2,2),W=1+j.width*j.height/1e5|0;B.register(r,n,i,a,s,o),B.process(new d(B),new v(B,j,2*W,O),new p(B,N),new l(B,N),new u(B),new m(B,X)),Array.apply(void 0,Array(W)).forEach(function(){B.create().add(new r(Math.random()*j.width,Math.random()*j.height,2*Math.random()*Math.PI),new n,new s,new i(V))});var z=0,H=function(){var t=(performance||Date).now();B.update((t-z||t)/1e3),z=t,requestAnimationFrame(H)};H();
