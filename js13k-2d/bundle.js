var t=function(t,e){this.c=t,this.p=null,this.n=e,this.d=!1};t.prototype.remove=function(){this.d=!0};var e=function(){this.h=null};e.prototype.add=function(e){var n=new t(e,this.h);return this.h&&(this.h.p=n),this.h=n,n},e.prototype.iterate=function(t){for(var e=this.h;e;)e.d?(e.p?e.p.n=e.n:this.h=e.n,e.n&&(e.n.p=e.p)):t(e.c),e=e.n};var n=new Stats;document.body.appendChild(n.dom);var r=document.getElementById("view"),i=function(t,n){var r,i=t.getContext("webgl",n),a=i.getExtension("ANGLE_instanced_arrays"),o=function(t,e){var n=i.createShader(e);return i.shaderSource(n,t),i.compileShader(n),n},c=function(t,e,n){var r=i.createBuffer();return i.bindBuffer(t,r),i.bufferData(t,e,n),r},u=[],h=function(t){var n=u.find(function(e){return e.z===t});return n||((n=new e).z=t,u.push(n),u.sort(function(t,e){return t.z<e.z?-1:t.z>e.z?1:0}),n)},s=h(0),v=function(t,e){var n=o("precision mediump float;\nattribute vec2 g;\nattribute vec2 a;\nattribute vec2 t;\nattribute float r;\nattribute vec2 s;\nattribute vec4 u;\nattribute vec4 c;\nuniform mat4 m;\nvarying vec2 v;\nvarying vec4 vc;\nvoid main(){\nv=g+u.xy*u.zw;\nvc=c.abgr;\nvec2 p=(g-a)*s;\nfloat cr=cos(r);\nfloat sr=sin(r);\np=vec2(p.x*sr+p.y*cr,p.y*sr-p.x*cr);\np+=a+t;\ngl_Position=m*vec4(p,0,1);}",i.VERTEX_SHADER),r=o("precision mediump float;\nuniform sampler2D x;\nvarying vec2 v;\nvarying vec4 vc;\nvoid main(){gl_FragColor=texture2D(x,v)*vc;}",i.FRAGMENT_SHADER),a=i.createProgram();return i.attachShader(a,n),i.attachShader(a,r),i.linkProgram(a),a}(),E=(c(i.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,2,1,3]),i.STATIC_DRAW),function(t,e,n,r,o,c,u){var h=i.getAttribLocation(v,t);return i.enableVertexAttribArray(h),i.vertexAttribPointer(h,e,c||i.FLOAT,!!u,n||0,o||0),r&&a.vertexAttribDivisorANGLE(h,r),h}),f=(c(i.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),i.STATIC_DRAW),E("g",2),new ArrayBuffer(524256)),d=new Float32Array(f),l=new Uint32Array(f),m=(c(i.ARRAY_BUFFER,f,i.DYNAMIC_DRAW),E("a",2,48,1),E("s",2,48,1,8),E("r",1,48,1,16),E("t",2,48,1,20),E("u",4,48,1,28),E("c",4,48,1,44,i.UNSIGNED_BYTE,!0),i.getUniformLocation(v,"m")),p=i.getUniformLocation(v,"x"),R=0,T=function(){R&&(i.bufferSubData(i.ARRAY_BUFFER,0,d.subarray(0,12*R)),a.drawElementsInstancedANGLE(i.TRIANGLES,6,i.UNSIGNED_SHORT,0,R),console.log(R),R=0)},g=function(){var e=t.clientWidth,n=t.clientHeight;t.width=e,t.height=n,i.viewport(0,0,e,n),i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.clear(i.COLOR_BUFFER_BIT);var a=[2/e,0,0,0,0,-2/n,0,0,0,0,1,0,-1,1,0,1];i.useProgram(v),i.activeTexture(i.TEXTURE0),i.uniformMatrix4fv(m,!1,a),r=null,u.forEach(function(t){return t.iterate(function(t){return function(t){if(t.visible){10922===R&&T();var e=t.bitmap,n=e.tex,a=e.width,o=e.height,c=e.uvs;r!==n&&(T(),r=n,i.bindTexture(i.TEXTURE_2D,n),i.uniform1i(p,n));var u=12*R;d[u++]=t.anchor.x,d[u++]=t.anchor.y,d[u++]=t.scale.x*a,d[u++]=t.scale.y*o,d[u++]=t.rotation+Math.PI/2,d[u++]=t.position.x,d[u++]=t.position.y,d[u++]=c[0],d[u++]=c[1],d[u++]=c[2],d[u++]=c[3],l[u++]=((16777215&t.tint)<<8|255*t.alpha&255)>>>0,R++}}(t)})}),T()},_=function(t){this.bitmap=t,this.anchor={x:.5,y:.5},this.position={x:0,y:0},this.rotation=0,this.scale={x:1,y:1},this.tint=16777215,this.alpha=1,this.visible=!0};return _.prototype.remove=function(){},g(),{gl:i,bkg:function(t,e,n){i.clearColor(t,e,n,1)},texture:function(t,e,n,r,a){var o=i.createTexture();return i.bindTexture(i.TEXTURE_2D,o),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,e||i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,n||i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,a||i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r||i.LINEAR),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t),i.generateMipmap(i.TEXTURE_2D),{tex:o,width:t.width,height:t.height,uvs:[0,0,1,1]}},bitmap:function(t,e,n,r,i){var a=r-e,o=i-n;return{tex:t.tex,width:Math.abs(a),height:Math.abs(o),uvs:[e/t.width,n/t.height,a/t.width,o/t.height]}},layer:h,Sprite:_,add:function(t,e){var n=(e||s).add(t);t.remove=n.remove.bind(n)},render:g}}(r),a=i.gl;console.log(i.gl),i.bkg(.2,.2,.2,1);var o=i.texture(function(){var t=document.createElement("canvas");t.width=32,t.height=32;var e=t.getContext("2d");e.lineWidth=2,e.fillStyle="#888888",e.strokeStyle="#ffffff",e.beginPath(),e.moveTo(16,16);for(var n=Math.PI/5;n<2*Math.PI;n+=2*Math.PI/5)e.lineTo(16+15*Math.cos(n),16+15*Math.sin(n));return e.closePath(),e.fill(),e.stroke(),t}()),c=0,u=function(t){c+=t;for(var e=0;e<t;e++){var n=new i.Sprite(o);n.position={x:.1*r.width+Math.random()*r.width*.8,y:.1*r.height+Math.random()*r.height*.8},n.anchor={x:.5,y:.5},n.tint=16777215*Math.random(),n.alpha=.8,n.scale={x:.5,y:.5},n.rotation=Math.random()*Math.PI*2,n.dr=.2*(.5-Math.random()),i.add(n)}};u(3e3);var h=document.getElementById("sprites"),s=a.getExtension("WEBGL_debug_renderer_info"),v=a.getParameter(s?s.UNMASKED_RENDERER_WEBGL:a.VENDOR),E=!1;r.onmousedown=function(){E=!0},r.ontouchstart=function(){E=!0},r.onmouseup=function(){E=!1},r.ontouchend=function(){E=!1};var f=function(){n.begin(),E&&u(50),h.innerHTML="<pre>Renderer: "+v+"\nSprites: "+c+"</pre>",i.layer(0).iterate(function(t){t.rotation+=t.dr}),i.render(),n.end(),requestAnimationFrame(f)};f();
